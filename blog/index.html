<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.75">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="KubeVela Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="KubeVela Blog Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-5GLR1Y52M7"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-5GLR1Y52M7",{})</script>
<link rel="search" type="application/opensearchdescription+xml" title="KubeVela" href="/opensearch.xml"><title data-react-helmet="true">Blog | KubeVela</title><meta data-react-helmet="true" property="og:title" content="Blog | KubeVela"><meta data-react-helmet="true" name="description" content="Blog"><meta data-react-helmet="true" property="og:description" content="Blog"><meta data-react-helmet="true" property="og:url" content="https://kubevela.io/blog"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="blog_posts_list"><meta data-react-helmet="true" property="og:image" content="https://tva1.sinaimg.cn/large/ad5fbf65gy1glgj5q8inej208g049aa6.jpg"><meta data-react-helmet="true" name="twitter:image" content="https://tva1.sinaimg.cn/large/ad5fbf65gy1glgj5q8inej208g049aa6.jpg"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://kubevela.io/blog"><link data-react-helmet="true" rel="alternate" href="https://kubevela.io/blog" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://kubevela.io/zh/blog" hreflang="zh"><link data-react-helmet="true" rel="alternate" href="https://kubevela.io/blog" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.e34c5d79.css">
<link rel="preload" href="/assets/js/runtime~main.b842a96d.js" as="script">
<link rel="preload" href="/assets/js/main.56dd577b.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle" type="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="KubeVela" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/logoDark.svg" alt="KubeVela" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">KubeVela</strong></a><a class="navbar__item navbar__link" href="/docs/">Documentation</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__item navbar__link" href="/docs/">v1.0</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/next/">Next</a></li><li><a class="dropdown__link" href="/docs/">v1.0</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__item navbar__link"><span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" width="20" height="20" style="vertical-align:text-bottom;margin-right:5px"><path fill="currentColor" d="M19.753 10.909c-.624-1.707-2.366-2.726-4.661-2.726-.09 0-.176.002-.262.006l-.016-2.063 3.525-.607c.115-.019.133-.119.109-.231-.023-.111-.167-.883-.188-.976-.027-.131-.102-.127-.207-.109-.104.018-3.25.461-3.25.461l-.013-2.078c-.001-.125-.069-.158-.194-.156l-1.025.016c-.105.002-.164.049-.162.148l.033 2.307s-3.061.527-3.144.543c-.084.014-.17.053-.151.143.019.09.19 1.094.208 1.172.018.08.072.129.188.107l2.924-.504.035 2.018c-1.077.281-1.801.824-2.256 1.303-.768.807-1.207 1.887-1.207 2.963 0 1.586.971 2.529 2.328 2.695 3.162.387 5.119-3.06 5.769-4.715 1.097 1.506.256 4.354-2.094 5.98-.043.029-.098.129-.033.207l.619.756c.08.096.206.059.256.023 2.51-1.73 3.661-4.515 2.869-6.683zm-7.386 3.188c-.966-.121-.944-.914-.944-1.453 0-.773.327-1.58.876-2.156a3.21 3.21 0 011.229-.799l.082 4.277a2.773 2.773 0 01-1.243.131zm2.427-.553l.046-4.109c.084-.004.166-.01.252-.01.773 0 1.494.145 1.885.361.391.217-1.023 2.713-2.183 3.758zm-8.95-7.668a.196.196 0 00-.196-.145h-1.95a.194.194 0 00-.194.144L.008 16.916c-.017.051-.011.076.062.076h1.733c.075 0 .099-.023.114-.072l1.008-3.318h3.496l1.008 3.318c.016.049.039.072.113.072h1.734c.072 0 .078-.025.062-.076-.014-.05-3.083-9.741-3.494-11.04zm-2.618 6.318l1.447-5.25 1.447 5.25H3.226z"></path></svg><span>English</span></span></a><ul class="dropdown__menu"><li><a href="/blog" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" style="text-transform:capitalize">English</a></li><li><a href="/zh/blog" target="_self" rel="noopener noreferrer" class="dropdown__link" style="text-transform:capitalize">简体中文</a></li><li><a class="dropdown__link" href="/blog/kubevela-official-documentation-translation-event">Help Us Translate</a></li></ul></div><a href="https://github.com/oam-dev/kubevela" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-githab-link"></a><div class="react-toggle displayOnlyInLargeViewport_GrZ2 react-toggle--disabled" role="button" tabindex="-1"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_71bT">🌜</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">🌞</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span></button></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="KubeVela" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/logoDark.svg" alt="KubeVela" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">KubeVela</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a role="button" class="menu__link menu__link--sublist">Versions</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/next/">Next</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/">v1.0</a></li></ul></li><li class="menu__list-item"><a class="menu__link" href="/docs/">Documentation</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/blog">Blog</a></li><li class="menu__list-item menu__list-item--collapsed"><a href="#" role="button" class="menu__link menu__link--sublist"><span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" width="20" height="20" style="vertical-align:text-bottom;margin-right:5px"><path fill="currentColor" d="M19.753 10.909c-.624-1.707-2.366-2.726-4.661-2.726-.09 0-.176.002-.262.006l-.016-2.063 3.525-.607c.115-.019.133-.119.109-.231-.023-.111-.167-.883-.188-.976-.027-.131-.102-.127-.207-.109-.104.018-3.25.461-3.25.461l-.013-2.078c-.001-.125-.069-.158-.194-.156l-1.025.016c-.105.002-.164.049-.162.148l.033 2.307s-3.061.527-3.144.543c-.084.014-.17.053-.151.143.019.09.19 1.094.208 1.172.018.08.072.129.188.107l2.924-.504.035 2.018c-1.077.281-1.801.824-2.256 1.303-.768.807-1.207 1.887-1.207 2.963 0 1.586.971 2.529 2.328 2.695 3.162.387 5.119-3.06 5.769-4.715 1.097 1.506.256 4.354-2.094 5.98-.043.029-.098.129-.033.207l.619.756c.08.096.206.059.256.023 2.51-1.73 3.661-4.515 2.869-6.683zm-7.386 3.188c-.966-.121-.944-.914-.944-1.453 0-.773.327-1.58.876-2.156a3.21 3.21 0 011.229-.799l.082 4.277a2.773 2.773 0 01-1.243.131zm2.427-.553l.046-4.109c.084-.004.166-.01.252-.01.773 0 1.494.145 1.885.361.391.217-1.023 2.713-2.183 3.758zm-8.95-7.668a.196.196 0 00-.196-.145h-1.95a.194.194 0 00-.194.144L.008 16.916c-.017.051-.011.076.062.076h1.733c.075 0 .099-.023.114-.072l1.008-3.318h3.496l1.008 3.318c.016.049.039.072.113.072h1.734c.072 0 .078-.025.062-.076-.014-.05-3.083-9.741-3.494-11.04zm-2.618 6.318l1.447-5.25 1.447 5.25H3.226z"></path></svg><span>Languages</span></span></a><ul class="menu__list"><li class="menu__list-item"><a href="/blog" target="_self" rel="noopener noreferrer" class="menu__link dropdown__link--active" style="text-transform:capitalize">English</a></li><li class="menu__list-item"><a href="/zh/blog" target="_self" rel="noopener noreferrer" class="menu__link" style="text-transform:capitalize">简体中文</a></li><li class="menu__list-item"><a class="menu__link" href="/blog/kubevela-official-documentation-translation-event">Help Us Translate</a></li></ul></li><li class="menu__list-item"><a href="https://github.com/oam-dev/kubevela" target="_blank" rel="noopener noreferrer" class="menu__link header-githab-link"></a></li></ul></div></div></div></nav><div class="main-wrapper blog-wrapper blog-list-page"><div class="container margin-vert--lg"><div class="row"><div class="col col--3"><div class="sidebar_2ahu thin-scrollbar"><h3 class="sidebarItemTitle_2hhb">Recent posts</h3><ul class="sidebarItemList_2xAf"><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/extend-kubevela-by-cuelang-in-20-mins">如何在 20 分钟内给你的 K8s PaaS 上线一个新功能</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/kubevela-jenkins-cicd">使用 Jenkins + KubeVela 完成应用的持续交付</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/kubevela-official-documentation-translation-event">KubeVela Official Documentation Translation Event</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/kubevela-performance-test">KubeVela Performance Test - Managing Massive Applications</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/kubevela-the-extensible-app-platform-based-on-open-application-model-and-kubernetes">KubeVela - The Extensible App Platform Based on Open Application Model and Kubernetes</a></li></ul></div></div><main class="col col--7"><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_GeHD"><a href="/blog/extend-kubevela-by-cuelang-in-20-mins"></a></h2><div class="margin-vert--md"><time datetime="2021-09-02T14:21:43.641Z" class="blogPostDate_fNvV">September 2, 2021 · 9 min read</time></div><div class="avatar margin-vert--md"><div class="avatar__intro"></div></div></header><div class="markdown"><blockquote><p>2020年12月14日 19:33, by @wonderflow</p></blockquote><p>上个月，<a href="https://kubevela.io/#/blog/zh/kubevela-the-extensible-app-platform-based-on-open-application-model-and-kubernetes" target="_blank" rel="noopener noreferrer">KubeVela 正式发布</a>了，
作为一款简单易用且高度可扩展的应用管理平台与核心引擎，可以说是广大平台工程师用来构建自己的云原生 PaaS 的神兵利器。
那么本文就以一个实际的例子，讲解一下如何在 20 分钟内，为你基于 KubeVela 的 PaaS “上线“一个新能力。</p><p>在正式开始本文档的教程之前，请确保你本地已经正确<a href="https://kubevela.io/#/en/install" target="_blank" rel="noopener noreferrer">安装了 KubeVela</a> 及其依赖的 K8s 环境。</p><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="kubevela-扩展的基本结构"></a>KubeVela 扩展的基本结构<a class="hash-link" href="#kubevela-扩展的基本结构" title="Direct link to heading">#</a></h1><p>KubeVela 的基本架构如图所示：</p><p><img src="https://kubevela-docs.oss-cn-beijing.aliyuncs.com/kubevela-extend.jpg" alt="image"></p><p>简单来说，KubeVela 通过添加 <strong>Workload Type</strong> 和 <strong>Trait</strong> 来为用户扩展能力，平台的服务提供方通过 Definition 文件注册和扩展，向上通过 Appfile 透出扩展的功能。官方文档中也分别给出了基本的编写流程，其中2个是Workload的扩展例子，一个是Trait的扩展例子：</p><ul><li><a href="https://kubevela.io/#/en/platform-engineers/workload-type" target="_blank" rel="noopener noreferrer">OpenFaaS 为例的 Workload Type 扩展</a></li><li><a href="https://kubevela.io/#/en/platform-engineers/cloud-services" target="_blank" rel="noopener noreferrer">云资源 RDS 为例的 Workload Type 扩展</a></li><li><a href="https://kubevela.io/#/en/platform-engineers/trait" target="_blank" rel="noopener noreferrer">KubeWatch 为例的 Trait 扩展</a></li></ul><p>我们以一个内置的 WorkloadDefinition 为例来介绍一下 Definition 文件的基本结构：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><div tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> core.oam.dev/v1alpha2</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> WorkloadDefinition</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> webservice</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">annotations</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">definition.oam.dev/description</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> &quot;`Webservice` is a workload type to describe long</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">running</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> scalable</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> containerized services that have a stable network endpoint to receive external network traffic from customers.</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    If workload type is skipped for any service defined in Appfile</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> it will be defaulted to `Web Service` type.&quot;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">definitionRef</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> deployments.apps</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">extension</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">template</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token scalar string" style="color:rgb(255, 121, 198)"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">      output: {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">        apiVersion: &quot;apps/v1&quot;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">        kind:       &quot;Deployment&quot;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">        spec: {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            selector: matchLabels: {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                &quot;app.oam.dev/component&quot;: context.name</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            template: {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                metadata: labels: {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                    &quot;app.oam.dev/component&quot;: context.name</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                spec: {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                    containers: [{</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                        name:  context.name</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                        image: parameter.image</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                        if parameter[&quot;cmd&quot;] != _|_ {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                            command: parameter.cmd</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                        }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                        if parameter[&quot;env&quot;] != _|_ {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                            env: parameter.env</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                        }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                        if context[&quot;config&quot;] != _|_ {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                            env: context.config</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                        }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                        ports: [{</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                            containerPort: parameter.port</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                        }]</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                        if parameter[&quot;cpu&quot;] != _|_ {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                            resources: {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                                limits:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                                    cpu: parameter.cpu</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                                requests:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                                    cpu: parameter.cpu</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                            }}</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                    }]</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            }}}</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">      }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">      parameter: {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">        // +usage=Which image would you like to use for your service</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">        // +short=i</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">        image: string</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        // +usage=Commands to run in the container</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">cmd?</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">...</span><span class="token plain">string</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        // +usage=Which port do you want customer traffic sent to</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        // +short=p</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token important">*80</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> int</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        // +usage=Define arguments by using environment variables</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">env?</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">...</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            // +usage=Environment variable name</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> string</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            // +usage=The value of the environment variable</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">value?</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> string</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            // +usage=Specifies a source the value of this var should come from</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">valueFrom?</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                // +usage=Selects a key of a secret in the pod&#x27;s namespace</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token key atrule">secretKeyRef</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    // +usage=The name of the secret in the pod&#x27;s namespace to select from</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> string</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    // +usage=The key of the secret to select from. Must be a valid secret key</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    </span><span class="token key atrule">key</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> string</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        // +usage=Number of CPU units for the service</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> like `0.5` (0.5 CPU core)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> `1` (1 CPU core)</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">cpu?</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> string</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>乍一看挺长的，好像很复杂，但是不要着急，其实细看之下它分为两部分：</p><ul><li>不含扩展字段的 Definition 注册部分。</li><li>供 Appfile 使用的扩展模板（CUE Template）部分 </li></ul><p>我们拆开来慢慢介绍，其实学起来很简单。</p><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="不含扩展字段的-definition-注册部分"></a>不含扩展字段的 Definition 注册部分<a class="hash-link" href="#不含扩展字段的-definition-注册部分" title="Direct link to heading">#</a></h1><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><div tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> core.oam.dev/v1alpha2</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> WorkloadDefinition</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> webservice</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">annotations</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">definition.oam.dev/description</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> &quot;`Webservice` is a workload type to describe long</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">running</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> scalable</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> containerized services that have a stable network endpoint to receive external network traffic from customers.</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    If workload type is skipped for any service defined in Appfile</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> it will be defaulted to `Web Service` type.&quot;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">definitionRef</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> deployments.apps</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>这一部分满打满算11行，其中有3行是在介绍 <code>webservice</code>的功能，5行是固定的格式。只有2行是有特定信息：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><div tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">definitionRef</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> deployments.apps</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>这两行的意思代表了这个Definition背后用的CRD名称是什么，其格式是 <code>&lt;resources&gt;.&lt;api-group&gt;</code>.了解 K8s 的同学应该知道 K8s 中比较常用的是通过 <code>api-group</code>, <code>version</code> 和 <code>kind</code> 定位资源，而 <code>kind</code> 在 K8s restful API 中对应的是 <code>resources</code>。以大家熟悉 <code>Deployment</code> 和 <code>ingress</code> 为例，它的对应关系如下：</p><table><thead><tr><th>api-group</th><th>kind</th><th>version</th><th>resources</th></tr></thead><tbody><tr><td>apps</td><td>Deployment</td><td>v1</td><td>deployments</td></tr><tr><td>networking.k8s.io</td><td>Ingress</td><td>v1</td><td>ingresses</td></tr></tbody></table><blockquote><p>这里补充一个小知识，为什么有了 kind 还要加个 resources 的概念呢？
因为一个 CRD 除了 kind 本身还有一些像 status，replica 这样的字段希望跟 spec 本身解耦开来在 restful API 中单独更新，
所以 resources 除了 kind 对应的那一个，还会有一些额外的 resources，如 Deployment 的 status 表示为 <code>deployments/status</code>。</p></blockquote><p>所以相信聪明的你已经明白了不含 extension 的情况下，Definition应该怎么写了，最简单的就是根据 K8s 的资源组合方式拼接一下，只要填下面三个尖括号的空格就可以了。</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><div tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> core.oam.dev/v1alpha2</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> WorkloadDefinition</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> &lt;这里写名称</span><span class="token punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">definitionRef</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> &lt;这里写resources</span><span class="token punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain">.&lt;这里写api</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">group</span><span class="token punctuation" style="color:rgb(248, 248, 242)">&gt;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>针对运维特征注册（TraitDefinition）也是这样。</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><div tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> core.oam.dev/v1alpha2</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> TraitDefinition</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> &lt;这里写名称</span><span class="token punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">definitionRef</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> &lt;这里写resources</span><span class="token punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain">.&lt;这里写api</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">group</span><span class="token punctuation" style="color:rgb(248, 248, 242)">&gt;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>所以把 <code>Ingress</code> 作为 KubeVela 的扩展写进去就是：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><div tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> core.oam.dev/v1alpha2</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> TraitDefinition</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">  ingress</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">definitionRef</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> ingresses.networking.k8s.io</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>除此之外，TraitDefinition 中还增加了一些其他功能模型层功能，如：</p><ul><li><code>appliesToWorkloads</code>: 表示这个 trait 可以作用于哪些 Workload 类型。</li><li><code>conflictWith</code>： 表示这个 trait 和哪些其他类型的 trait 有冲突。</li><li><code>workloadRefPath</code>： 表示这个 trait 包含的 workload 字段是哪个，KubeVela 在生成 trait 对象时会自动填充。
... </li></ul><p>这些功能都是可选的，本文中不涉及使用，在后续的其他文章中我们再给大家详细介绍。</p><p>所以到这里，相信你已经掌握了一个不含 extensions 的基本扩展模式，而剩下部分就是围绕 <a href="https://cuelang.org/" target="_blank" rel="noopener noreferrer">CUE</a> 的抽象模板。</p><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="供-appfile-使用的扩展模板（cue-template）部分"></a>供 Appfile 使用的扩展模板（CUE Template）部分<a class="hash-link" href="#供-appfile-使用的扩展模板（cue-template）部分" title="Direct link to heading">#</a></h1><p>对 CUE 本身有兴趣的同学可以参考这篇<a href="https://wonderflow.info/posts/2020-12-15-cuelang-template/" target="_blank" rel="noopener noreferrer">CUE 基础入门</a> 多做一些了解，限于篇幅本文对 CUE 本身不详细展开。</p><p>大家知道 KubeVela 的 Appfile 写起来很简洁，但是 K8s 的对象是一个相对比较复杂的 YAML，而为了保持简洁的同时又不失可扩展性，KubeVela 提供了一个从复杂到简洁的桥梁。
这就是 Definition 中 CUE Template 的作用。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="cue-格式模板"></a>CUE 格式模板<a class="hash-link" href="#cue-格式模板" title="Direct link to heading">#</a></h2><p>让我们先来看一个 Deployment 的 YAML 文件，如下所示，其中很多内容都是固定的框架（模板部分），真正需要用户填的内容其实就少量的几个字段（参数部分）。</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><div tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> apps/v1</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Deployment</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">meadata</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> mytest</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">template</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">containers</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> mytest</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">env</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> a</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">value</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> b</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> nginx</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">v1</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">labels</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">app.oam.dev/component</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> mytest</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">selector</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">matchLabels</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">app.oam.dev/component</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> mytest</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>在 KubeVela 中，Definition 文件的固定格式就是分为 <code>output</code> 和 <code>parameter</code> 两部分。其中<code>output</code>中的内容就是“模板部分”，而 <code>parameter</code> 就是参数部分。</p><p>那我们来把上面的 Deployment YAML 改写成 Definition 中模板的格式。</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cue"><div tabindex="0" class="prism-code language-cue codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">output: {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    apiVersion: &quot;apps/v1&quot;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    kind:       &quot;Deployment&quot;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    metadata: name: &quot;mytest&quot;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    spec: {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        selector: matchLabels: {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            &quot;app.oam.dev/component&quot;: &quot;mytest&quot;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        template: {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            metadata: labels: {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                &quot;app.oam.dev/component&quot;: &quot;mytest&quot;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            spec: {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                containers: [{</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    name:  &quot;mytest&quot;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    image: &quot;nginx:v1&quot;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    env: [{name:&quot;a&quot;,value:&quot;b&quot;}]</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                }]</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            }}}</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>这个格式跟 json 很像，事实上这个是 CUE 的格式，而 CUE 本身就是一个 json 的超集。也就是说，CUE的格式在满足 JSON 规则的基础上，增加了一些简便规则，
使其更易读易用：</p><ul><li>C 语言的注释风格。</li><li>表示字段名称的双引号在没有特殊符号的情况下可以缺省。</li><li>字段值结尾的逗号可以缺省，在字段最后的逗号写了也不会出错。</li><li>最外层的大括号可以省略。</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="cue-格式的模板参数--变量引用"></a>CUE 格式的模板参数--变量引用<a class="hash-link" href="#cue-格式的模板参数--变量引用" title="Direct link to heading">#</a></h2><p>编写好了模板部分，让我们来构建参数部分，而这个参数其实就是变量的引用。</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">parameter: {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    name: string</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    image: string</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">}</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">output: {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    apiVersion: &quot;apps/v1&quot;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    kind:       &quot;Deployment&quot;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    spec: {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        selector: matchLabels: {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            &quot;app.oam.dev/component&quot;: parameter.name</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        template: {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            metadata: labels: {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                &quot;app.oam.dev/component&quot;: parameter.name</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            spec: {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                containers: [{</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    name:  parameter.name</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    image: parameter.image</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                }]</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            }}}</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>如上面的这个例子所示，KubeVela 中的模板参数就是通过 <code>parameter</code> 这个部分来完成的，而<code>parameter</code> 本质上就是作为引用，替换掉了 <code>output</code> 中的某些字段。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="完整的-definition-以及在-appfile-使用"></a>完整的 Definition 以及在 Appfile 使用<a class="hash-link" href="#完整的-definition-以及在-appfile-使用" title="Direct link to heading">#</a></h2><p>事实上，经过上面两部分的组合，我们已经可以写出一个完整的 Definition 文件：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><div tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> core.oam.dev/v1alpha2</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> WorkloadDefinition</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> mydeploy</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">definitionRef</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> deployments.apps</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">extension</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">template</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token scalar string" style="color:rgb(255, 121, 198)"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">        parameter: {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            name: string</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            image: string</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">        }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">        output: {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            apiVersion: &quot;apps/v1&quot;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            kind:       &quot;Deployment&quot;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">            spec: {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                selector: matchLabels: {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                    &quot;app.oam.dev/component&quot;: parameter.name</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                template: {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                    metadata: labels: {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                        &quot;app.oam.dev/component&quot;: parameter.name</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                    }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                    spec: {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                        containers: [{</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                            name:  parameter.name</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                            image: parameter.image</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                        }]</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">                    }}}</span></div><div class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">        }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>为了方便调试，一般情况下可以预先分为两个文件，一部分放前面的 yaml 部分，假设命名为 <code>def.yaml</code> 如：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><div tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">apiVersion: core.oam.dev/v1alpha2</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kind: WorkloadDefinition</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">metadata:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  name: mydeploy</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">spec:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  definitionRef:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    name: deployments.apps</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  extension:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    template: </span><span class="token operator">|</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>另一个则放 cue 文件，假设命名为 <code>def.cue</code> ：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><div tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">parameter: </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    name: string</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    image: string</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">output: </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    apiVersion: </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;apps/v1&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    kind:       </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;Deployment&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    spec: </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        selector: matchLabels: </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;app.oam.dev/component&quot;</span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">:</span><span class="token plain"> parameter.name</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        template: </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            metadata: labels: </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;app.oam.dev/component&quot;</span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">:</span><span class="token plain"> parameter.name</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            spec: </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                containers: </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    name:  parameter.name</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    image: parameter.image</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>先对 <code>def.cue</code> 做一个格式化，格式化的同时 cue 工具本身会做一些校验，也可以更深入的<a href="https://wonderflow.info/posts/2020-12-15-cuelang-template/" target="_blank" rel="noopener noreferrer">通过 cue 命令做调试</a>:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><div tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">cue </span><span class="token function" style="color:rgb(80, 250, 123)">fmt</span><span class="token plain"> def.cue</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>调试完成后，可以通过脚本把这个 yaml 组装：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><div tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">./hack/vela-templates/mergedef.sh def.yaml def.cue </span><span class="token operator">&gt;</span><span class="token plain"> mydeploy.yaml</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>再把这个 yaml 文件 apply 到 K8s 集群中。</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><div tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ kubectl apply -f mydeploy.yaml</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">workloaddefinition.core.oam.dev/mydeploy created</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>一旦新能力 <code>kubectl apply</code> 到了 Kubernetes 中，不用重启，也不用更新，KubeVela 的用户可以立刻看到一个新的能力出现并且可以使用了：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><div tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ vela worklaods</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">Automatically discover capabilities successfully ✅ Add</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> Update</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> Delete</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">TYPE        CATEGORY    DESCRIPTION</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">+mydeploy   workload    description not defined</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">NAME        DESCRIPTION</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">mydeploy    description not defined</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>在 Appfile 中使用方式如下：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><div tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> my</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">extend</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">app</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">services</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">mysvc</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> mydeploy</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> crccheck/hello</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">world</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> mysvc</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>执行 <code>vela up</code> 就能把这个运行起来了：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><div tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ vela up -f docs/examples/blog-extension/my-extend-app.yaml</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">Parsing vela appfile </span><span class="token punctuation" style="color:rgb(248, 248, 242)">..</span><span class="token plain">.</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">Loading templates </span><span class="token punctuation" style="color:rgb(248, 248, 242)">..</span><span class="token plain">.</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">Rendering configs </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">for</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">service</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">mysvc</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">..</span><span class="token plain">.</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">Writing deploy config to </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">.vela/deploy.yaml</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">Applying deploy configs </span><span class="token punctuation" style="color:rgb(248, 248, 242)">..</span><span class="token plain">.</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">Checking </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> app has been deployed</span><span class="token punctuation" style="color:rgb(248, 248, 242)">..</span><span class="token plain">.</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">App has not been deployed, creating a new deployment</span><span class="token punctuation" style="color:rgb(248, 248, 242)">..</span><span class="token plain">.</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">✅ App has been deployed 🚀🚀🚀</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    Port forward: vela port-forward my-extend-app</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">             SSH: vela </span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">exec</span><span class="token plain"> my-extend-app</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">         Logging: vela logs my-extend-app</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      App status: vela status my-extend-app</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  Service status: vela status my-extend-app --svc mysvc</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>我们来查看一下应用的状态，已经正常运行起来了（<code>HEALTHY Ready: 1/1</code>）：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><div tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ vela status my-extend-app</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">About:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  Name:         my-extend-app</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  Namespace:    env-application</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  Created at:   </span><span class="token number">2020</span><span class="token plain">-12-15 </span><span class="token number">16</span><span class="token plain">:32:25.08233 +0800 CST</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  Updated at:   </span><span class="token number">2020</span><span class="token plain">-12-15 </span><span class="token number">16</span><span class="token plain">:32:25.08233 +0800 CST</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">Services:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  - Name: mysvc</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    Type: mydeploy</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    HEALTHY Ready: </span><span class="token number">1</span><span class="token plain">/1</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="definition-模板中的高级用法"></a>Definition 模板中的高级用法<a class="hash-link" href="#definition-模板中的高级用法" title="Direct link to heading">#</a></h1><p>上面我们已经通过模板替换这个最基本的功能体验了扩展 KubeVela 的全过程，除此之外，可能你还有一些比较复杂的需求，如条件判断，循环，复杂类型等，需要一些高级的用法。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="结构体参数"></a>结构体参数<a class="hash-link" href="#结构体参数" title="Direct link to heading">#</a></h2><p>如果模板中有一些参数类型比较复杂，包含结构体和嵌套的多个结构体，就可以使用结构体定义。</p><ol><li>定义一个结构体类型，包含1个字符串成员、1个整型和1个结构体成员。</li></ol><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">#Config: {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    name:  string</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    value: int</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    other: {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      key: string</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      value: string</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><ol start="2"><li>在变量中使用这个结构体类型，并作为数组使用。</li></ol><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">parameter: {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    name: string</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    image: string</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    config: [...#Config]</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><ol start="3"><li>同样的目标中也是以变量引用的方式使用。</li></ol><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><div tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">output: </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">..</span><span class="token plain">.</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            spec: </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                containers: </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    name:  parameter.name</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    image: parameter.image</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    env: parameter.config</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">       </span><span class="token punctuation" style="color:rgb(248, 248, 242)">..</span><span class="token plain">.</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><ol start="4"><li>Appfile 中的写法就是按照 parameter 定义的结构编写。</li></ol><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">name: my-extend-app</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">services:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  mysvc:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    type: mydeploy</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    image: crccheck/hello-world</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    name: mysvc</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    config:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    - name: a</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      value: 1</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      other:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        key: mykey</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        value: myvalue</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="条件判断"></a>条件判断<a class="hash-link" href="#条件判断" title="Direct link to heading">#</a></h2><p>有时候某些参数加还是不加取决于某个条件：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><div tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">parameter: </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    name:   string</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    image:  string</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    useENV: bool</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">output: </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">..</span><span class="token plain">.</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    spec: </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        containers: </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            name:  parameter.name</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            image: parameter.image</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> parameter.useENV </span><span class="token operator">==</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                env: </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">name: </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;my-env&quot;</span><span class="token plain">, value: </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;my-value&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">..</span><span class="token plain">.</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>在 Appfile 就是写值。</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">name: my-extend-app</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">services:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  mysvc:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    type: mydeploy</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    image: crccheck/hello-world</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    name: mysvc</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    useENV: true</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="可缺省参数"></a>可缺省参数<a class="hash-link" href="#可缺省参数" title="Direct link to heading">#</a></h2><p>有些情况下参数可能存在也可能不存在，即非必填，这个时候一般要配合条件判断使用，对于某个字段不存在的情况，判断条件是是 <code>_variable != _|_</code>。</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><div tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">parameter: </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    name: string</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    image: string</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    config?: </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">..</span><span class="token plain">.</span><span class="token comment" style="color:rgb(98, 114, 164)">#Config]</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">output: </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">..</span><span class="token plain">.</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    spec: </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        containers: </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            name:  parameter.name</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            image: parameter.image</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> parameter.config </span><span class="token operator">!=</span><span class="token plain"> _</span><span class="token operator">|</span><span class="token plain">_ </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                config: parameter.config</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">..</span><span class="token plain">.</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>这种情况下 Appfile 的 config 就非必填了，填了就渲染，没填就不渲染。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="默认值"></a>默认值<a class="hash-link" href="#默认值" title="Direct link to heading">#</a></h2><p>对于某些参数如果希望设置一个默认值，可以采用这个写法。</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><div tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">parameter: </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    name: string</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    image: *</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;nginx:v1&quot;</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> string</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">output: </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">..</span><span class="token plain">.</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    spec: </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        containers: </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            name:  parameter.name</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            image: parameter.image</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">..</span><span class="token plain">.</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>这个时候 Appfile 就可以不写 image 这个参数，默认使用 &quot;nginx:v1&quot;：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">name: my-extend-app</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">services:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  mysvc:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    type: mydeploy</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    name: mysvc</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="循环"></a>循环<a class="hash-link" href="#循环" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="map-类型的循环"></a>Map 类型的循环<a class="hash-link" href="#map-类型的循环" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><div tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">parameter: </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    name:  string</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    image: string</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    env: </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">string</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain">: string</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">output: </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    spec: </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        containers: </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            name:  parameter.name</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            image: parameter.image</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            env: </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">for</span><span class="token plain"> k, </span><span class="token function" style="color:rgb(80, 250, 123)">v</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">in</span><span class="token plain"> parameter.env </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    name:  k</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    value: </span><span class="token function" style="color:rgb(80, 250, 123)">v</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain">,</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Appfile 中的写法：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">name: my-extend-app</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">services:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  mysvc:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    type: mydeploy</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    name:  &quot;mysvc&quot;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    image: &quot;nginx&quot;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    env:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      env1: value1</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      env2: value2</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="数组类型的循环"></a>数组类型的循环<a class="hash-link" href="#数组类型的循环" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><div tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">parameter: </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    name:  string</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    image: string</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    env: </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">..</span><span class="token plain">.</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">name:string,value:string</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">output: </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">..</span><span class="token plain">.</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    spec: </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        containers: </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            name:  parameter.name</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            image: parameter.image</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            env: </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">for</span><span class="token plain"> _, </span><span class="token function" style="color:rgb(80, 250, 123)">v</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">in</span><span class="token plain"> parameter.env </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    name:  v.name</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    value: v.value</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain">,</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Appfile 中的写法：</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">name: my-extend-app</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">services:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  mysvc:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    type: mydeploy</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    name:  &quot;mysvc&quot;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    image: &quot;nginx&quot;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    env:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    - name: env1</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      value: value1</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    - name: env2</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      value: value2</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="kubevela-内置的-context-变量"></a>KubeVela 内置的 <code>context</code> 变量<a class="hash-link" href="#kubevela-内置的-context-变量" title="Direct link to heading">#</a></h2><p>大家可能也注意到了，我们在 parameter 中定义的 name 每次在 Appfile中 实际上写了两次，一次是在 services 下面（每个service都以名称区分），
另一次则是在具体的<code>name</code>参数里面。事实上这里重复的不应该由用户再写一遍，所以 KubeVela 中还定义了一个内置的 <code>context</code>，里面存放了一些通用的环境上下文信息，如应用名称、秘钥等。
直接在模板中使用 context 就不需要额外增加一个 <code>name</code> 参数了， KubeVela 在运行渲染模板的过程中会自动传入。</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><div tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">parameter: </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    image: string</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">output: </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">..</span><span class="token plain">.</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    spec: </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        containers: </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            name:  context.name</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            image: parameter.image</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">..</span><span class="token plain">.</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="kubevela-中的注释增强"></a>KubeVela 中的注释增强<a class="hash-link" href="#kubevela-中的注释增强" title="Direct link to heading">#</a></h2><p>KubeVela 还对 cuelang 的注释做了一些扩展，方便自动生成文档以及被 CLI 使用。</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain"> parameter: {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        // +usage=Which image would you like to use for your service</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        // +short=i</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        image: string</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        // +usage=Commands to run in the container</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        cmd?: [...string]</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">       ...</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>其中，<code>+usgae</code> 开头的注释会变成参数的说明，<code>+short</code> 开头的注释后面则是在 CLI 中使用的缩写。</p><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="总结"></a>总结<a class="hash-link" href="#总结" title="Direct link to heading">#</a></h1><p>本文通过实际的案例和详细的讲述，为你介绍了在 KubeVela 中新增一个能力的详细过程与原理，以及能力模板的编写方法。</p><p>这里你可能还有个疑问，平台管理员这样添加了一个新能力后，平台的用户又该怎么能知道这个能力怎么使用呢？其实，在 KubeVela 中，它不仅能方便的添加新能力，<strong>它还能自动为“能力”生成 Markdown 格式的使用文档！</strong> 不信，你可以看下 KubeVela 本身的官方网站，所有在 <code>References/Capabilities</code>目录下能力使用说明文档（比如<a href="https://kubevela.io/#/en/developers/references/workload-types/webservice" target="_blank" rel="noopener noreferrer">这个</a>），全都是根据每个能力的模板自动生成的哦。
最后，欢迎大家写一些有趣的扩展功能，提交到 KubeVela 的<a href="https://github.com/oam-dev/catalog/tree/master/registry" target="_blank" rel="noopener noreferrer">社区仓库</a>中来。</p></div></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_GeHD"><a href="/blog/kubevela-jenkins-cicd">使用 Jenkins + KubeVela 完成应用的持续交付</a></h2><div class="margin-vert--md"><time datetime="2021-09-02T14:21:43.641Z" class="blogPostDate_fNvV">September 2, 2021 · 7 min read</time></div><div class="avatar margin-vert--md"><a href="https://github.com/oam-dev/kubevela" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img src="https://kubevela.io/img/logo.svg" alt="Da Yin, Yang Song"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/oam-dev/kubevela" target="_blank" rel="noopener noreferrer">Da Yin, Yang Song</a></h4><small class="avatar__subtitle">KubeVela Team</small></div></div></header><div class="markdown"><p>KubeVela 打通了应用与基础设施之间的交付管控的壁垒，相较于原生的 Kubernetes 对象，KubeVela 的 Application 更好地简化抽象了开发者需要关心的配置，将复杂的基础设施能力及编排细节留给了平台工程师。而 KubeVela 的 apiserver 则是进一步为开发者提供了使用 HTTP Request 直接操纵 Application 的途径，使得开发者即使没有 Kubernetes 的使用经验与集群访问权限也可以轻松部署自己的应用。</p><p>本文就以经典的持续集成 (Continuous Integration) 工具 Jenkins 为基础，简单介绍如何打造基于 GitOps 的应用持续交付的“高速公路”。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="持续交付高速公路"></a>持续交付“高速公路”<a class="hash-link" href="#持续交付高速公路" title="Direct link to heading">#</a></h2><p>作为应用开发者的你，更多地关心自己的应用是否正常运作，开发流程是否便捷高效。为此，在这条持续交付的“高速公路”上，将会由以下部件为你保驾护航。</p><ol><li>你需要一个 git 仓库来存放应用程序代码、测试代码，以及描述 KubeVela Application 的 YAML 文件。</li><li>你需要一个持续集成 (Continuous Integration) 的工具帮你自动化完成程序代码的测试，并打包成镜像上传到仓库中。</li><li>你需要在 Kubernetes 集群上安装 KubeVela 并启用 apiserver 功能。</li></ol><blockquote><p>目前 KubeVela 的 apiserver 在权限认证方面仍待完善，后续启用 apiserver 后将会加入权限配置环节。</p></blockquote><p>本文的介绍中采用了 Github 作为 git 仓库，Jenkins 作为 CI 工具，DockerHub 作为镜像仓库。应用程序以一个简单的 HTTP Server 为例，整个持续交付的流程如下。可以看到，在这条持续交付的“高速公路”上，开发者只需要关心应用的开发并使用 Git 进行代码版本的维护，即可自动走完测试流程并部署应用到 Kubernetes 集群中。</p><p><img alt="arch" src="/assets/images/arch-53b2b1a473f0d637d4c7c0b9a81dd2b0.png"></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="部署环境"></a>部署环境<a class="hash-link" href="#部署环境" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="jenkins-环境"></a>Jenkins 环境<a class="hash-link" href="#jenkins-环境" title="Direct link to heading">#</a></h3><blockquote><p>本文采用了 Jenkins 作为持续集成工具，开发者也可以使用其他 CI 工具，如 TravisCI 或者 GitHub Action。</p></blockquote><p>首先您需要准备一份 Jenkins 环境来部署 CI 流水线。安装与初始化 Jenkins 流程可以参见<a href="https://www.jenkins.io/doc/book/installing/linux/" target="_blank" rel="noopener noreferrer">官方文档</a>。</p><p>需要注意的是，由于本文的 CI 流水线是基于 Docker 及 GitHub 的，因此在安装 Jenkins 之后还需要安装相关插件 (Dashboard &gt; Manage Jenkins &gt; Manage Plugins) ，包括 Pipeline、HTTP Request Plugin、Docker Pipeline、Docker Plugin。</p><p>此外，还需要为 Jenkins 配置 Docker 的运行环境 (Dashboard &gt; Manage Jenkins &gt; Configure System &gt; Docker Builder) ，如 Jenkins 所在环境已经安装了 Docker，可以将 Docker URL 配置为 <code>unix:///var/run/docker.sock</code>。</p><p>由于在 CI 流水线运行过程中，还需要将容器镜像推至镜像仓库，为此需在 Jenkins 的 Credential 中将镜像仓库的账户配置好 (Dashboard &gt; Manage Jenkins &gt; Manage Credentials &gt; Add Credentials) ，比如将 DockerHub 的用户名及密码存入。</p><p><img alt="jenkins-credential" src="/assets/images/jenkins-credential-52c71b3f3a886ec0596a29a2356ad291.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="github-仓库环境"></a>GitHub 仓库环境<a class="hash-link" href="#github-仓库环境" title="Direct link to heading">#</a></h3><blockquote><p>本文的介绍采用了 Github 作为代码仓库，开发者还可以根据各自的需求与喜好，使用其他代码仓库，如 Gitlab。</p></blockquote><p>为使持续集成工具 Jenkins 能够获取到 GitHub 中的更新，并将流水线的运行状态反馈回 GitHub，需要在 GitHub 中完成以下两步操作。</p><ol><li><a href="https://github.com/settings/tokens/new" target="_blank" rel="noopener noreferrer">配置</a> Personal Access Token。注意将 <code>repo:status</code> 勾选，以获得向 GitHub 推送 Commit 状态的权限。</li></ol><p><img alt="github-pat" src="/assets/images/github-pat-a8de5950eaf01a6d416a869d70b189ac.png"></p><p>然后在 Jenkins 的 Credential 中加入 Secret Text 类型的 Credential 并将上述的 GitHub 的 Personal Access Token 填入。</p><p><img alt="jenkins-secret-text" src="/assets/images/jenkins-secret-text-0de6c324500b26a5bfb81520ff7eab2b.png"></p><p>最后来到 Jenkins 的 Dashboard &gt; Manage Jenkins &gt; Configure System &gt; GitHub 中点击 Add GitHub Server 并将刚才创建的 Credential 填入。完成后可以点击 Test connection 来验证配置是否正确。</p><p><img alt="jenkins-github" src="/assets/images/jenkins-github-e99c47fab606f6c9c9f3f6f841840329.png"></p><ol start="2"><li>在 GitHub 的代码仓库的设定里添加 Webhook，将 Jenkins 的地址对应的 Webhook 地址填入，比如 <a href="http://my-jenkins.example.com/github-webhook/" target="_blank" rel="noopener noreferrer">http://my-jenkins.example.com/github-webhook/</a> 。这样，该代码仓库的所有 Push 事件推送到 Jenkins 中。</li></ol><p><img alt="github-webhook" src="/assets/images/github-webhook-5579402b6bc37238d42842fd5d52fd02.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="kubevela-环境"></a>KubeVela 环境<a class="hash-link" href="#kubevela-环境" title="Direct link to heading">#</a></h3><p>在启用 apiserver 前，您需要在 Kubernetes 集群中安装 KubeVela，可以参考<a href="https://kubevela.io/docs/install" target="_blank" rel="noopener noreferrer">官方文档</a>。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="编写应用"></a>编写应用<a class="hash-link" href="#编写应用" title="Direct link to heading">#</a></h2><p>本文采用的应用是一个基于 Golang 语言编写的简单的 HTTP Server。在代码中，声明了一个名叫 <code>VERSION</code> 的常量，并在访问该服务时打印出来。同时还附带一个简单的测试，用来校验 <code>VERSION</code> 的格式是否符合标准。</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly go"><div tabindex="0" class="prism-code language-go codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">// main.go</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">package</span><span class="token plain"> main</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">import</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;fmt&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;net/http&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> VERSION </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;0.1.0-v1alpha1&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">func</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">main</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    http</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">HandleFunc</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;/&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">func</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">w http</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">ResponseWriter</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> r </span><span class="token operator">*</span><span class="token plain">http</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">Request</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token boolean">_</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token boolean">_</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> fmt</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">Fprintf</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">w</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;Version: %s\n&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> VERSION</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> err </span><span class="token operator">:=</span><span class="token plain"> http</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">ListenAndServe</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;:8088&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token boolean">nil</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"> err </span><span class="token operator">!=</span><span class="token plain"> </span><span class="token boolean">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">println</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">err</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">Error</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly go"><div tabindex="0" class="prism-code language-go codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">// main_test.go</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">package</span><span class="token plain"> main</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">import</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;regexp&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;testing&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> verRegex </span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">`^v?([0-9]+)(\.[0-9]+)?(\.[0-9]+)?`</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token string" style="color:rgb(255, 121, 198)">`(-([0-9A-Za-z\-]+(\.[0-9A-Za-z\-]+)*))?`</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token string" style="color:rgb(255, 121, 198)">`(\+([0-9A-Za-z\-]+(\.[0-9A-Za-z\-]+)*))?$`</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">func</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">TestVersion</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">t </span><span class="token operator">*</span><span class="token plain">testing</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">T</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> ok</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token boolean">_</span><span class="token plain"> </span><span class="token operator">:=</span><span class="token plain"> regexp</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">MatchString</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">verRegex</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> VERSION</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"> </span><span class="token operator">!</span><span class="token plain">ok </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        t</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">Fatalf</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;invalid version: %s&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> VERSION</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>在应用交付时需要将 Golang 服务打包成镜像并以 KubeVela Application 的形式发布到 Kubernetes 集群中，因此在代码仓库中还包含 <code>Dockerfile</code> 以及 <code>app.yaml</code> 文件，分别用来描述镜像的打包方式以及 Application 的相关配置。</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly Dockerfile"><div tabindex="0" class="prism-code language-Dockerfile codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain"># Dockerfile</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">FROM golang:1.13-rc-alpine3.10 as builder</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">WORKDIR /app</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">COPY main.go .</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">RUN go build -o kubevela-demo-cicd-app main.go</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">FROM alpine:3.10</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">WORKDIR /app</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">COPY --from=builder /app/kubevela-demo-cicd-app /app/kubevela-demo-cicd-app</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">ENTRYPOINT ./kubevela-demo-cicd-app</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">EXPOSE 8088</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>在 app.yaml 中，声明了部署的应用包含 5 个不同副本，同时通过 Ingress 的形式发布给集群外部。而 labels 则是给应用中的 Pod 打上了当前的 git commit 作为标签。当 Jenkins 的部署流水线运行时，会将 GIT_COMMIT 注入其中，提交到 KubeVela apiserver，从而触发 Application 的更新。在版本更新过程中，按照 3, 3 的数量分两次次更新副本，同时在第一次更新后停止自动更新，等待手动确认后再进行全部更新，实现金丝雀发布的过程。</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><div tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># app.yaml</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> core.oam.dev/v1beta1</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Application</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> kubevela</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">demo</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">app</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">components</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> kubevela</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">demo</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">app</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">web</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> webservice</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">properties</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> somefive/kubevela</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">demo</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">cicd</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">app</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">imagePullPolicy</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Always</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">8080</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">traits</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> rollout</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">properties</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">rolloutBatches</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">replicas</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">2</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">replicas</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">3</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">batchPartition</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">targetSize</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">5</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> labels</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">properties</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">jenkins-build-commit</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> GIT_COMMIT</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> ingress</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">properties</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">domain</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> kubevela</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">demo</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">cicd</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">app.cf7c0ed25b151437ebe1ef58efc29bca4.us</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">west</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">1.alicontainer.com</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">http</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token key atrule">&quot;/&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">8088</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="配置-ci-流水线"></a>配置 CI 流水线<a class="hash-link" href="#配置-ci-流水线" title="Direct link to heading">#</a></h2><p>在本文的案例中，包含两条流水线，一条是用来进行测试的流水线 (对应用代码运行测试) ，一条是交付流水线 (将应用代码打包上传镜像仓库，同时更新目标环境中的应用，实现自动更新) 。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="测试流水线"></a>测试流水线<a class="hash-link" href="#测试流水线" title="Direct link to heading">#</a></h3><p>在 Jenkins 中创建一条新的 Pipeline，并配置 Build Triggers 为 GitHub hook trigger for GITScm polling。</p><p><img alt="test-pipeline-create" src="/assets/images/test-pipeline-create-34edf7a7b95307cec884803ca545c2e3.png">
<img alt="test-pipeline-config" src="/assets/images/test-pipeline-config-3ae2830ca7d45dbe9579a7814d96abc0.png"></p><p>在这条流水线中，首先是采用了 golang 的镜像作为执行环境，方便后续运行测试。然后将分支配置为 GitHub 仓库中的 dev 分支，代表该条流水线被 Push 事件触发后会拉取 dev 分支上的内容并执行测试。测试结束后将流水线的状态回写至 GitHub 中。</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly groovy"><div tabindex="0" class="prism-code language-groovy codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">void setBuildStatus(String message, String state) {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  step([</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      $class: &quot;GitHubCommitStatusSetter&quot;,</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      reposSource: [$class: &quot;ManuallyEnteredRepositorySource&quot;, url: &quot;https://github.com/Somefive/KubeVela-demo-CICD-app&quot;],</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      contextSource: [$class: &quot;ManuallyEnteredCommitContextSource&quot;, context: &quot;ci/jenkins/test-status&quot;],</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      errorHandlers: [[$class: &quot;ChangingBuildStatusErrorHandler&quot;, result: &quot;UNSTABLE&quot;]],</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      statusResultSource: [ $class: &quot;ConditionalStatusResultSource&quot;, results: [[$class: &quot;AnyBuildResult&quot;, message: message, state: state]] ]</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  ]);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">}</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">pipeline {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    agent {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        docker { image &#x27;golang:1.13-rc-alpine3.10&#x27; }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    stages {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        stage(&#x27;Prepare&#x27;) {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            steps {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                script {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    def checkout = git branch: &#x27;dev&#x27;, url: &#x27;https://github.com/Somefive/KubeVela-demo-CICD-app.git&#x27;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    env.GIT_COMMIT = checkout.GIT_COMMIT</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    env.GIT_BRANCH = checkout.GIT_BRANCH</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    echo &quot;env.GIT_BRANCH=${env.GIT_BRANCH},env.GIT_COMMIT=${env.GIT_COMMIT}&quot;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                setBuildStatus(&quot;Test running&quot;, &quot;PENDING&quot;);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        stage(&#x27;Test&#x27;) {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            steps {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                sh &#x27;CGO_ENABLED=0 GOCACHE=$(pwd)/.cache go test *.go&#x27;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    post {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        success {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            setBuildStatus(&quot;Test success&quot;, &quot;SUCCESS&quot;);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        failure {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            setBuildStatus(&quot;Test failed&quot;, &quot;FAILURE&quot;);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="部署流水线"></a>部署流水线<a class="hash-link" href="#部署流水线" title="Direct link to heading">#</a></h3><p>在部署流水线中，类似测试流水线，首先将代码仓库中的分支拉取下来，区别是这里采用 prod 分支。然后使用 Docker 进行镜像构建并推送至远端镜像仓库 (这里为 DockerHub，其中 withRegistry 中填写镜像仓库位置以及在先前步骤中存入的 DockerHub 的账户对应的 Credential 的 ID) 。构建成功后，再将 Application 对应的 YAML 文件转换为 JSON 文件并注入 GIT_COMMIT，最后向 KubeVela apiserver (此处为 <a href="http://47.88.24.19/" target="_blank" rel="noopener noreferrer">http://47.88.24.19/</a>) 发送请求进行创建或更新。</p><blockquote><p>目前的 KubeVela apiserver 接收 JSON 参数，因此在流水线中做了相应的转换。未来的 KubeVela apiserver 将会进一步改进交互模式，简化此处的流程，同时再加上更为严格的权限认证，提高安全性。</p></blockquote><blockquote><p>该案例中会向 kubevela-demo-app 这个 Namespace 中创建名叫 cicd-demo-app 的应用，注意这个 Namespace 需要预先在 Kubernetes 中创建出来。未来 KubeVela 的 apiserver 同样会简化这一流程。</p></blockquote><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly groovy"><div tabindex="0" class="prism-code language-groovy codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">void setBuildStatus(String message, String state) {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  step([</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      $class: &quot;GitHubCommitStatusSetter&quot;,</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      reposSource: [$class: &quot;ManuallyEnteredRepositorySource&quot;, url: &quot;https://github.com/Somefive/KubeVela-demo-CICD-app&quot;],</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      contextSource: [$class: &quot;ManuallyEnteredCommitContextSource&quot;, context: &quot;ci/jenkins/deploy-status&quot;],</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      errorHandlers: [[$class: &quot;ChangingBuildStatusErrorHandler&quot;, result: &quot;UNSTABLE&quot;]],</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      statusResultSource: [ $class: &quot;ConditionalStatusResultSource&quot;, results: [[$class: &quot;AnyBuildResult&quot;, message: message, state: state]] ]</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  ]);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">}</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">pipeline {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    agent any</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    stages {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        stage(&#x27;Prepare&#x27;) {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            steps {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                script {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    def checkout = git branch: &#x27;prod&#x27;, url: &#x27;https://github.com/Somefive/KubeVela-demo-CICD-app.git&#x27;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    env.GIT_COMMIT = checkout.GIT_COMMIT</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    env.GIT_BRANCH = checkout.GIT_BRANCH</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    echo &quot;env.GIT_BRANCH=${env.GIT_BRANCH},env.GIT_COMMIT=${env.GIT_COMMIT}&quot;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    setBuildStatus(&quot;Deploy running&quot;, &quot;PENDING&quot;);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        stage(&#x27;Build&#x27;) {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            steps {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                script {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    docker.withRegistry(&quot;https://registry.hub.docker.com&quot;, &quot;DockerHubCredential&quot;) {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                        def customImage = docker.build(&quot;somefive/hello-world:kubevela-demo-cicd-app&quot;)</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                        customImage.push()</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        stage(&#x27;Deploy&#x27;) {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            steps {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                sh &#x27;wget -q &quot;https://github.com/mikefarah/yq/releases/download/v4.12.1/yq_linux_amd64&quot;&#x27;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                sh &#x27;chmod +x yq_linux_amd64&#x27;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                script {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    def app = sh (</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                        script: &quot;./yq_linux_amd64 eval -o=json &#x27;.spec&#x27; app.yaml | sed -e &#x27;s/GIT_COMMIT/$GIT_COMMIT/g&#x27;&quot;,</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                        returnStdout: true</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    )</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    echo &quot;app: ${app}&quot;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    def response = httpRequest acceptType: &#x27;APPLICATION_JSON&#x27;, contentType: &#x27;APPLICATION_JSON&#x27;, httpMode: &#x27;POST&#x27;, requestBody: app, url: &quot;http://47.88.24.19/v1/namespaces/kubevela-demo-app/applications/cicd-demo-app&quot;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    println(&#x27;Status: &#x27;+response.status)</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                    println(&#x27;Response: &#x27;+response.content)</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    post {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        success {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            setBuildStatus(&quot;Deploy success&quot;, &quot;SUCCESS&quot;);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        failure {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            setBuildStatus(&quot;Deploy failed&quot;, &quot;FAILURE&quot;);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="实际表现"></a>实际表现<a class="hash-link" href="#实际表现" title="Direct link to heading">#</a></h2><p>在完成上述的配置流程后，持续交付的流程便已经搭建完成。我们可以来检验一下它的效果。</p><p><img alt="pipeline-overview" src="/assets/images/pipeline-overview-36827d3925d667b9d14612cb59e8fb4e.png"></p><p>我们首先将 <code>main.go</code> 中的 <code>VERSION</code> 字段修改为 <code>Bad Version Number</code>，即</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly go"><div tabindex="0" class="prism-code language-go codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> VERSION </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;Bad Version Number&quot;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>然后提交该修改至 dev 分支。我们可以看到 Jenkins 上的测试流水线被触发运行，失败后将该状态回写给 GitHub。</p><p><img alt="test-pipeline-fail" src="/assets/images/test-pipeline-fail-23682b9d0c60a43f26be0a5a98e8a413.png">
<img alt="test-github-fail" src="/assets/images/test-github-fail-5dd21696c58a212cf6ca2ee80e56567e.png"></p><p>我们重新将 VERSION 修改为 0.1.1，然后再次提交。可以看到这一次测试流水线成功完成执行，并在 GitHub 对应的 Commit 上看到了成功的标志。</p><p><img alt="test-pipeline-success" src="/assets/images/test-pipeline-success-cd84def7976efb35b5071c9e361d2a77.png">
<img alt="test-github-success" src="/assets/images/test-github-success-1d9c59d67bfd9b24d8b455fa21c6d985.png"></p><p>接下来我们在 GitHub 上提交 Pull Request 尝试将 dev 分支上的更新合并至 prod 分支上。</p><p><img alt="pull-request" src="/assets/images/pull-request-eca7ff259bb26a6661d79691728b0b31.png"></p><p>可以看到在 Jenkins 的部署流水线成功运行结束后，GitHub 上 prod 分支最新的 Commit 也显示了成功的标志。</p><p><img alt="deploy-pipeline-success" src="/assets/images/deploy-pipeline-success-7890c92b41e666ef46f3bd2dc1975ee7.png">
<img alt="deploy-github-success" src="/assets/images/deploy-github-success-07f305b1b587e3fa8acc5df68fd8c297.png"></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><div tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ kubectl get app -n kubevela-demo-namespace</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">NAME                     COMPONENT               TYPE         PHASE     HEALTHY   STATUS   AGE</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-cicd-app   kubevela-demo-app-web   webservice   running   </span><span class="token boolean">true</span><span class="token plain">               112s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ kubectl get deployment -n kubevela-demo-namespace</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">NAME                       READY   UP-TO-DATE   AVAILABLE   AGE</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v1   </span><span class="token number">2</span><span class="token plain">/2     </span><span class="token number">2</span><span class="token plain">            </span><span class="token number">2</span><span class="token plain">           2m1s</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>如图显示，要部署的应用顺利被 KubeVela apiserver 接受并由 KubeVela 控制器创建了相关资源。当前 Deployment 的副本数是 2，在删除了该 Application 中 rollout 特征内的 batchPatition: 0 后代表确认了当前的发布，然后对应的 Deployment 副本数更新至 5。这时我们可以访问 Ingress 所配置的域名，成功显示了当前的版本号。</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><div tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ kubectl edit app -n kubevela-demo-namespace</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">application.core.oam.dev/kubevela-demo-cicd-app edited</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ kubectl get deployment -n kubevela-demo-namespace -w</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">NAME                       READY   UP-TO-DATE   AVAILABLE   AGE</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v1   </span><span class="token number">4</span><span class="token plain">/5     </span><span class="token number">5</span><span class="token plain">            </span><span class="token number">4</span><span class="token plain">           3m39s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v1   </span><span class="token number">5</span><span class="token plain">/5     </span><span class="token number">5</span><span class="token plain">            </span><span class="token number">5</span><span class="token plain">           3m39s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v1   </span><span class="token number">5</span><span class="token plain">/5     </span><span class="token number">5</span><span class="token plain">            </span><span class="token number">5</span><span class="token plain">           3m40s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v1   </span><span class="token number">5</span><span class="token plain">/5     </span><span class="token number">5</span><span class="token plain">            </span><span class="token number">5</span><span class="token plain">           3m40s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ </span><span class="token function" style="color:rgb(80, 250, 123)">curl</span><span class="token plain"> http://kubevela-demo-cicd-app.cf7c0ed25b151437ebe1ef58efc29bca4.us-west-1.alicontainer.com/</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">Version: </span><span class="token number">0.1</span><span class="token plain">.1</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>我们重复以上步骤，将版本升级至 0.1.2，完成测试流水线及部署流水线。接着我们会发现 Kubernetes 的集群内对应的 Application 控制的 Deployment 发生了版本更替，旧版本的 Deployment 从 5 副本下降到 3 副本，新版本的 Deployment 则出现了 2 副本。如果此时我们再访问原来的服务地址，会发现有时会显示 0.1.1 版本，有时会显示 0.1.2 版本。这是因为在当前滚动更新过程中，新旧副本同时存在，访问的流量会被负载均衡器分发到不同的副本上，因此会出现两种版本的服务同时存在的现象。</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><div tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ kubectl get deployment -n kubevela-demo-namespace -w</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">NAME                       READY   UP-TO-DATE   AVAILABLE   AGE</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v1   </span><span class="token number">5</span><span class="token plain">/5     </span><span class="token number">5</span><span class="token plain">            </span><span class="token number">5</span><span class="token plain">           11m</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">0</span><span class="token plain">/0     </span><span class="token number">0</span><span class="token plain">            </span><span class="token number">0</span><span class="token plain">           0s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">0</span><span class="token plain">/0     </span><span class="token number">0</span><span class="token plain">            </span><span class="token number">0</span><span class="token plain">           0s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">0</span><span class="token plain">/0     </span><span class="token number">0</span><span class="token plain">            </span><span class="token number">0</span><span class="token plain">           0s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v1   </span><span class="token number">5</span><span class="token plain">/5     </span><span class="token number">5</span><span class="token plain">            </span><span class="token number">5</span><span class="token plain">           12m</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">0</span><span class="token plain">/0     </span><span class="token number">0</span><span class="token plain">            </span><span class="token number">0</span><span class="token plain">           0s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">0</span><span class="token plain">/0     </span><span class="token number">0</span><span class="token plain">            </span><span class="token number">0</span><span class="token plain">           0s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">0</span><span class="token plain">/0     </span><span class="token number">0</span><span class="token plain">            </span><span class="token number">0</span><span class="token plain">           0s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">0</span><span class="token plain">/0     </span><span class="token number">0</span><span class="token plain">            </span><span class="token number">0</span><span class="token plain">           0s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">0</span><span class="token plain">/2     </span><span class="token number">0</span><span class="token plain">            </span><span class="token number">0</span><span class="token plain">           0s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">0</span><span class="token plain">/2     </span><span class="token number">0</span><span class="token plain">            </span><span class="token number">0</span><span class="token plain">           0s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">0</span><span class="token plain">/2     </span><span class="token number">0</span><span class="token plain">            </span><span class="token number">0</span><span class="token plain">           0s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">0</span><span class="token plain">/2     </span><span class="token number">2</span><span class="token plain">            </span><span class="token number">0</span><span class="token plain">           0s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v1   </span><span class="token number">5</span><span class="token plain">/5     </span><span class="token number">5</span><span class="token plain">            </span><span class="token number">5</span><span class="token plain">           12m</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">1</span><span class="token plain">/2     </span><span class="token number">2</span><span class="token plain">            </span><span class="token number">1</span><span class="token plain">           2s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">2</span><span class="token plain">/2     </span><span class="token number">2</span><span class="token plain">            </span><span class="token number">2</span><span class="token plain">           2s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v1   </span><span class="token number">5</span><span class="token plain">/3     </span><span class="token number">5</span><span class="token plain">            </span><span class="token number">5</span><span class="token plain">           13m</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v1   </span><span class="token number">5</span><span class="token plain">/3     </span><span class="token number">5</span><span class="token plain">            </span><span class="token number">5</span><span class="token plain">           13m</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v1   </span><span class="token number">3</span><span class="token plain">/3     </span><span class="token number">3</span><span class="token plain">            </span><span class="token number">3</span><span class="token plain">           13m</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><div tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ </span><span class="token function" style="color:rgb(80, 250, 123)">curl</span><span class="token plain"> http://kubevela-demo-cicd-app.cf7c0ed25b151437ebe1ef58efc29bca4.us-west-1.alicontainer.com/</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">Version: </span><span class="token number">0.1</span><span class="token plain">.1</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ </span><span class="token function" style="color:rgb(80, 250, 123)">curl</span><span class="token plain"> http://kubevela-demo-cicd-app.cf7c0ed25b151437ebe1ef58efc29bca4.us-west-1.alicontainer.com/</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">Version: </span><span class="token number">0.1</span><span class="token plain">.1</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ </span><span class="token function" style="color:rgb(80, 250, 123)">curl</span><span class="token plain"> http://kubevela-demo-cicd-app.cf7c0ed25b151437ebe1ef58efc29bca4.us-west-1.alicontainer.com/</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">Version: </span><span class="token number">0.1</span><span class="token plain">.1</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ </span><span class="token function" style="color:rgb(80, 250, 123)">curl</span><span class="token plain"> http://kubevela-demo-cicd-app.cf7c0ed25b151437ebe1ef58efc29bca4.us-west-1.alicontainer.com/</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">Version: </span><span class="token number">0.1</span><span class="token plain">.1</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ </span><span class="token function" style="color:rgb(80, 250, 123)">curl</span><span class="token plain"> http://kubevela-demo-cicd-app.cf7c0ed25b151437ebe1ef58efc29bca4.us-west-1.alicontainer.com/</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">Version: </span><span class="token number">0.1</span><span class="token plain">.2</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ </span><span class="token function" style="color:rgb(80, 250, 123)">curl</span><span class="token plain"> http://kubevela-demo-cicd-app.cf7c0ed25b151437ebe1ef58efc29bca4.us-west-1.alicontainer.com/</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">Version: </span><span class="token number">0.1</span><span class="token plain">.2</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ </span><span class="token function" style="color:rgb(80, 250, 123)">curl</span><span class="token plain"> http://kubevela-demo-cicd-app.cf7c0ed25b151437ebe1ef58efc29bca4.us-west-1.alicontainer.com/</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">Version: </span><span class="token number">0.1</span><span class="token plain">.2</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ </span><span class="token function" style="color:rgb(80, 250, 123)">curl</span><span class="token plain"> http://kubevela-demo-cicd-app.cf7c0ed25b151437ebe1ef58efc29bca4.us-west-1.alicontainer.com/</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">Version: </span><span class="token number">0.1</span><span class="token plain">.2</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ </span><span class="token function" style="color:rgb(80, 250, 123)">curl</span><span class="token plain"> http://kubevela-demo-cicd-app.cf7c0ed25b151437ebe1ef58efc29bca4.us-west-1.alicontainer.com/</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">Version: </span><span class="token number">0.1</span><span class="token plain">.1</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>当我们确认新版本的服务正常运作后，可以类似上述步骤，将 Application 中 rollout 特性内的 batchPartition: 0 删去，完成整个金丝雀发布流程。</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><div tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ kubectl get deployment -n kubevela-demo-namespace -w</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">NAME                       READY   UP-TO-DATE   AVAILABLE   AGE</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v1   </span><span class="token number">3</span><span class="token plain">/3     </span><span class="token number">3</span><span class="token plain">            </span><span class="token number">3</span><span class="token plain">           18m</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">2</span><span class="token plain">/2     </span><span class="token number">2</span><span class="token plain">            </span><span class="token number">2</span><span class="token plain">           5m24s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">2</span><span class="token plain">/5     </span><span class="token number">2</span><span class="token plain">            </span><span class="token number">2</span><span class="token plain">           5m36s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">2</span><span class="token plain">/5     </span><span class="token number">2</span><span class="token plain">            </span><span class="token number">2</span><span class="token plain">           5m37s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">2</span><span class="token plain">/5     </span><span class="token number">2</span><span class="token plain">            </span><span class="token number">2</span><span class="token plain">           5m37s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">2</span><span class="token plain">/5     </span><span class="token number">5</span><span class="token plain">            </span><span class="token number">2</span><span class="token plain">           5m37s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">3</span><span class="token plain">/5     </span><span class="token number">5</span><span class="token plain">            </span><span class="token number">3</span><span class="token plain">           5m38s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">4</span><span class="token plain">/5     </span><span class="token number">5</span><span class="token plain">            </span><span class="token number">4</span><span class="token plain">           5m38s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">5</span><span class="token plain">/5     </span><span class="token number">5</span><span class="token plain">            </span><span class="token number">5</span><span class="token plain">           5m39s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v1   </span><span class="token number">3</span><span class="token plain">/0     </span><span class="token number">3</span><span class="token plain">            </span><span class="token number">3</span><span class="token plain">           18m</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v1   </span><span class="token number">3</span><span class="token plain">/0     </span><span class="token number">3</span><span class="token plain">            </span><span class="token number">3</span><span class="token plain">           18m</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v1   </span><span class="token number">0</span><span class="token plain">/0     </span><span class="token number">0</span><span class="token plain">            </span><span class="token number">0</span><span class="token plain">           18m</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v1   </span><span class="token number">0</span><span class="token plain">/0     </span><span class="token number">0</span><span class="token plain">            </span><span class="token number">0</span><span class="token plain">           18m</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">5</span><span class="token plain">/5     </span><span class="token number">5</span><span class="token plain">            </span><span class="token number">5</span><span class="token plain">           5m41s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v2   </span><span class="token number">5</span><span class="token plain">/5     </span><span class="token number">5</span><span class="token plain">            </span><span class="token number">5</span><span class="token plain">           5m41s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">kubevela-demo-app-web-v1   </span><span class="token number">0</span><span class="token plain">/0     </span><span class="token number">0</span><span class="token plain">            </span><span class="token number">0</span><span class="token plain">           18m</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="小结"></a>小结<a class="hash-link" href="#小结" title="Direct link to heading">#</a></h2><p>至此，我们便已经成功实现了一整套持续交付流程。在这个流程中，应用的开发者借助 KubeVela + Jenkins 的能力，可以轻松完成应用的迭代更新、集成测试、自动发布与滚动升级，而整个流程在各个环节也可以按照开发者的喜好和条件选择不同的工具，比如使用 Gitlab 替代 GitHub，或是使用 TravisCI 替代 Jenkins。</p><p>在上述过程中，细心的读者可能还会发现，这套流程不仅能够实现应用服务的升级，而且还可以通过修改 app.yaml 自动完成部署方案的升级，比如将 5 副本应用扩容到 10 副本，或是为容器添加 sidecar，从而实现部分 GitOps 能力。关于使用 KubeVela 实践 GitOps 的更多内容，感兴趣的读者可以继续阅读相关案例。</p></div><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog/tags/kubevela">kubevela</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_GeHD"><a href="/blog/kubevela-official-documentation-translation-event">KubeVela Official Documentation Translation Event</a></h2><div class="margin-vert--md"><time datetime="2021-09-02T14:21:43.641Z" class="blogPostDate_fNvV">September 2, 2021 · 2 min read</time></div><div class="avatar margin-vert--md"><div class="avatar__intro"></div></div></header><div class="markdown"><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="背景"></a>背景<a class="hash-link" href="#背景" title="Direct link to heading">#</a></h2><p>KubeVela v1.0 启用了新的官网架构和文档维护方式，新增功能包括文档版本化控制、i18n 国际化以及自动化流程。但目前 KubeVela 官方文档只有英文版，这提高了学习和使用 KubeVela 的门槛，不利于项目的传播和发展，同时翻译工作也能显著提升语言能力，帮助我们拓宽阅读技术资料的广度，故组织本次活动。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="活动流程"></a>活动流程<a class="hash-link" href="#活动流程" title="Direct link to heading">#</a></h2><p>本次活动主要在 <a href="https://github.com/oam-dev/kubevela.io" target="_blank" rel="noopener noreferrer">kubevela.io</a> repo 下进行，报名参与和认领任务都在 <a href="https://shimo.im/sheets/QrCwcDqh8xkRWKPC/MODOC" target="_blank" rel="noopener noreferrer">KubeVela 官方文档翻译登记</a> 中（<strong>请务必在表格中登记信息</strong>）。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="开始翻译"></a>开始翻译<a class="hash-link" href="#开始翻译" title="Direct link to heading">#</a></h3><p><img src="https://tvax1.sinaimg.cn/large/ad5fbf65gy1gpdbriuraij20k20l6dhm.jpg" alt="翻译流程"></p><p>参与翻译活动的基本流程如下：</p><ul><li>任务领取：在 <a href="https://shimo.im/sheets/QrCwcDqh8xkRWKPC/MODOC" target="_blank" rel="noopener noreferrer">KubeVela 官方文档翻译登记</a> 登记并认领任务；</li><li>提交：参与人员提交 PR 等待 review；</li><li>审阅：maintainer 审阅 PR；</li><li>终审： 对 review 后的内容进行最后确认；</li><li>合并：merge 到 master 分支，任务结束。</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="参与指南"></a>参与指南<a class="hash-link" href="#参与指南" title="Direct link to heading">#</a></h3><p>下面具体介绍参与翻译的具体工作。</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="准备工作"></a>准备工作<a class="hash-link" href="#准备工作" title="Direct link to heading">#</a></h4><ul><li>账号：你需要先准备一个 GitHub 账号。使用 Github 进行翻译任务的认领和 PR 提交。</li><li>仓库和分支管理<ul><li>fork <a href="https://github.com/oam-dev/kubevela.io" target="_blank" rel="noopener noreferrer">kubevela.io</a> 的仓库，并作为自己仓库的上游： <code>git remote add upstream https://github.com/oam-dev/kubevela.io.git</code></li><li>在自己的仓库，也就是 origin 上进行翻译；</li><li>一个任务新建一个 branch</li></ul></li><li>Node.js 版本 &gt;= 12.13.0 （可以使用 <code>node -v</code> 命令查看）</li><li>Yarn 版本 &gt;= 1.5（可以使用 <code>yarn --version</code> 命令查看）</li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="参与步骤"></a>参与步骤<a class="hash-link" href="#参与步骤" title="Direct link to heading">#</a></h4><p><strong>Step1：任务浏览</strong></p><p>在 <a href="https://shimo.im/sheets/QrCwcDqh8xkRWKPC/MODOC" target="_blank" rel="noopener noreferrer">KubeVela 官方文档翻译登记</a> 登记并浏览有哪些任务可以认领。</p><p><strong>Step2：任务领取</strong></p><p>在 <a href="https://shimo.im/sheets/QrCwcDqh8xkRWKPC/MODOC" target="_blank" rel="noopener noreferrer">KubeVela 官方文档翻译登记</a> 表格中编辑并认领任务。注意：为保证质量，同一译者只能同时认领三个任务，完成后才可继续认领。</p><p><strong>Step3：本地构建和预览</strong></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><div tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># 命令安装依赖</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ </span><span class="token function" style="color:rgb(80, 250, 123)">yarn</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">install</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># 本地运行中文文档</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ </span><span class="token function" style="color:rgb(80, 250, 123)">yarn</span><span class="token plain"> run start -- --locale zh</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">yarn</span><span class="token plain"> run v1.22.10</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">warning From Yarn </span><span class="token number">1.0</span><span class="token plain"> onwards, scripts don&#x27;t require </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;--&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">for</span><span class="token plain"> options to be forwarded. In a future version, any explicit </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;--&quot;</span><span class="token plain"> will be forwarded as-is to the scripts.</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">$ docusaurus start --locale zh</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">Starting the development server</span><span class="token punctuation" style="color:rgb(248, 248, 242)">..</span><span class="token plain">.</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">Docusaurus website is running at: http://localhost:3000/zh/</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">✔ Client</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  Compiled successfully </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">in</span><span class="token plain"> </span><span class="token number">7</span><span class="token plain">.54s</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">ℹ ｢wds｣: Project is running at http://localhost:3000/</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">ℹ ｢wds｣: webpack output is served from /zh/</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">ℹ ｢wds｣: Content not from webpack is served from /Users/saybot/own/kubevela.io</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">ℹ ｢wds｣: 404s will fallback to /index.html</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">✔ Client</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  Compiled successfully </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">in</span><span class="token plain"> </span><span class="token number">137</span><span class="token plain">.94ms</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>请勿修改 <code>/docs</code> 目录下内容，中文文档在 <code>/i18n/zh/docusaurus-plugin-content-docs</code> 中，之后就可以在 http://localhost:3000/zh/ 中进行预览了。</p><p><strong>Step4：提交 PR</strong></p><p>确认翻译完成就可以提交 PR 了，注意：为了方便 review 每篇翻译为<strong>一个 PR</strong>，如果翻译多篇请 checkout <strong>多个分支</strong>并提交多个 PR。</p><p><strong>Step5：审阅</strong></p><p>由 maintainer 对 PR 进行 review。</p><p><strong>Step6：任务完成</strong></p><p>翻译合格的文章将会 merge 到 <a href="https://github.com/oam-dev/kubevela.io" target="_blank" rel="noopener noreferrer">kubevela.io</a> 的 master 分支进行发布。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="翻译要求"></a>翻译要求<a class="hash-link" href="#翻译要求" title="Direct link to heading">#</a></h3><ul><li>数字和英文两边是中文要加空格。</li><li>KubeVela 统一写法。K 和 V 大写。</li><li>翻译完请先阅读一遍，不要出现遗漏段落，保证文章通顺、符合中文阅读习惯。不追求严格一致，可以意译。review 的时候也会检验。</li><li>你和您不要混用，统一使用 <strong>“你”</strong>。</li><li>不会翻译的词汇可以不翻译，可以在 PR 中说明，review 的时候会查看。</li><li>Component、Workload、Trait 这些 OAM/KubeVela 里面定义的专属概念不要翻译，我们也要加强这些词汇的认知。可以在一篇新文章最开始出现的时候用括号加上中文翻译。</li><li>注意中英文标点符号。</li><li><code>PR</code> 命名规范 <code>Translate &lt;翻译文件相对路径&gt;</code>，如 <code>Translate i18n/zh/docusaurus-plugin-content-docs/current/introduction.md</code>。</li></ul></div><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog/tags/documentation">documentation</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_GeHD"><a href="/blog/kubevela-performance-test">KubeVela Performance Test - Managing Massive Applications</a></h2><div class="margin-vert--md"><time datetime="2021-09-02T14:21:43.641Z" class="blogPostDate_fNvV">September 2, 2021 · 9 min read</time></div><div class="avatar margin-vert--md"><a href="https://github.com/oam-dev/kubevela" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img src="https://kubevela.io/img/logo.svg" alt="Da Yin, Yang Song, Zhengxi Zhou and Jianbo Sun"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/oam-dev/kubevela" target="_blank" rel="noopener noreferrer">Da Yin, Yang Song, Zhengxi Zhou and Jianbo Sun</a></h4><small class="avatar__subtitle">KubeVela Team</small></div></div></header><div class="markdown"><p>As an application management and integration platform, KubeVela needs to handle thousands of applications in production scenario. To evaluate the performance of KubeVela, develop team has conducted performance tests based on simultated environments and demonstrated the capability of managing a large number of applications concurrently.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="setup"></a>Setup<a class="hash-link" href="#setup" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="cluster-environment"></a>Cluster Environment<a class="hash-link" href="#cluster-environment" title="Direct link to heading">#</a></h3><p>Working with large clusters requires lots of resources, such as Machines, Network Bandwidth, Storages and many other devices. Therefore, KubeVela team adopts kubemark, an official tool provided by kubernetes, to simulate large clusters by mocking hundreds of kubelets. Each kubelet works like a real node except that they do not run real containers inside pods. The aim of KubeVela performance test mainly focus on whether KubeVela controller can manage thousands of applications effectively, instead of pulling images or executing commands inside pods. As a result, we only need to get resources hosting these fake nodes, also named as hollow-nodes.</p><p>We set up the Kubernetes clusters on Alibaba Cloud which includes 5 master nodes and 15 worker nodes. The master nodes wil host Kubernetes core components such as kube-apiserver and kube-controller-manager. The worker nodes need to run other pressure-test related componets, including monitoring tools, KubeVela controller and kubemark pods. Since the major target is to test the performance of KubeVela controller, we do not expect other components to be the bottleneck of the pressure test. To this end, both master nodes and worker nodes are equiped with 32 cores and 128 Gi memory. We use the combination of Prometheus, Loki and Grafana as the monitoring suites and grant them enough resources in avoid of crash caused by Out-of-Memory.</p><p>Notice that KubeVela controller and monitoring tools need to be placed on real nodes to function while all pods created during performance tests should be assigned to hollow-nodes correctly. To achieve that, we give different taints to hollow-nodes and real nodes, and add corresponding tolerations to different pods.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="application"></a>Application<a class="hash-link" href="#application" title="Direct link to heading">#</a></h3><p>To simulate real applications in production, we design an application template with 2 components and 5 functional traits, including</p><ul><li>1 webservice component<ul><li>a scaler trait setting its replica to 3</li><li>a sidecar trait attaching another container to each pod</li><li>an ingress trait generating one ingress instance and one service instance</li></ul></li><li>1 worker component<ul><li>a scaler trait also setting its replica to 3</li><li>a configmap trait generating a new configmap and attaching it to worker pods</li></ul></li></ul><p>In the following experiment, we test the performance of KubeVela controller managing 3,000 Applications (12,000 Pods in total) on 200 nodes. Applications are created in parallel at first, then kept running for a while, and finally deleted from the cluster. Each application will be reconciled multiple times with latencies and consumed resources recorded by monitoring tools.</p><blockquote><p>In practice, we also have another trait used for adding tolerations as described above.</p></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="kubevela-controller"></a>KubeVela Controller<a class="hash-link" href="#kubevela-controller" title="Direct link to heading">#</a></h3><p>The KubeVela controller is set up with a group of recommendation configurations as follows</p><ul><li>Kubernetes Resource<ul><li>0.5 core CPU</li><li>1 Gi Memory</li><li>1 replica</li></ul></li><li>Program <ul><li>concurrent-reconciles=2 (The number of reconcile threads)</li><li>kube-api-qps=300 (The qps of kubernetes client used in controller)</li><li>kube-api-burst=500 (The burst of kubernetes client used in controller)</li><li>informer-re-sync-interval=20m (The interval of routine reconciles.)
We will analyze these settings in the below sections.</li></ul></li></ul><blockquote><p>To evaluate the performance of KubeVela Controller itself, we disabled the Ingress MutatingWebhook and Application ValidatingWebhook which is beyond the focus of this test but will affect the performance of KubeVela Controller by increasing the latency of creating/patching resources.</p></blockquote><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="experiments"></a>Experiments<a class="hash-link" href="#experiments" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="creation"></a>Creation<a class="hash-link" href="#creation" title="Direct link to heading">#</a></h3><p>The creation of all 3,000 applications lasted 25min. Getting all pods running takes a bit longer time, which is out of the scope of KubeVela controller. </p><p>For each application creation, it will trigger three turns of reconciling. The usage of CPU will reach 100% in the late period of creation. The memory usage will increase as the number of applications rises. It reaches around 67% at the end of creation.</p><p><img alt="create-cpu" src="/assets/images/create-cpu-50a2f951ca18219c47f86fc87861387a.png">
<img alt="create-memory" src="/assets/images/create-memory-1d5a108aa88dca5b5233df07b975869f.png"></p><p>The average time of the first turn reconciling is relatively short since it only needs patch finalizer. The second and third turn reconciling contain full reconcile cycles and need more time to process. The following charts record the time consumptions of different period during reconciling applications. The average time is generally below 200ms while 99% of reconciles uses less than 800ms.</p><p><img alt="create-avg-time" src="/assets/images/create-avg-time-c9096f848bacebb15879e354db90ad79.png">
<img alt="create-p99-time" src="/assets/images/create-p99-time-6834848739195ef1a6836e8830a60940.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="regular-reconciles"></a>Regular Reconciles<a class="hash-link" href="#regular-reconciles" title="Direct link to heading">#</a></h3><p>After creation, applications are reconciled by controller every 20min. the monitoring of 8-hour reconcile process are displayed as below. The CPU usage will come up to 90% once reconcile happens routinely. The memory usage generally keeps a stable pattern, up to 75% memory usage.</p><p><img alt="med-cpu" src="/assets/images/med-cpu-1ee6beebe2ddac70499b2fe0f1200346.png">
<img alt="med-memory" src="/assets/images/med-memory-84ee70599fdfe10c539d31a8ffd011f3.png"></p><p>The average reconcile time is under 200ms while 99% are about 800ms~900ms. Each regular reconcile for all applications generally takes around 10min.</p><p><img alt="med-avg" src="/assets/images/med-avg-71e81f42a57ba18fe977c1cb8f041e6f.png">
<img alt="med-p99" src="/assets/images/med-p99-660473173a37679faf8f5c54a4668b7c.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="deletion"></a>Deletion<a class="hash-link" href="#deletion" title="Direct link to heading">#</a></h3><p>The application deletion process is fast and low-resource consumptive. It takes less than 3min to delete all applications. However, notice that the deletion of resources managed by application usually takes longer time. This is because the cleanup of these resources (such as deployments or pods) are not directly controlled by the KubeVela controller. KubeVela controller takes charge of deleting their owner and cleanup them by triggering cascading deletion. In addition, each deletion is associated with two turns of reconcile where the second turn returns immediately when it fails to retrieve target applciation (since it is deleted).</p><p><img alt="del-cpu" src="/assets/images/del-cpu-e20c033c8d55123b17d4daf25af8b0e1.png">
<img alt="del-memory" src="/assets/images/del-memory-7185fe1f634f7bfede12924608db96f2.png">
<img alt="del-avg" src="/assets/images/del-avg-b8c9b19de6d6472f5ad751ee5b13cd22.png">
<img alt="del-p99" src="/assets/images/del-p99-c2efbbd508a210d006bbb511944ec547.png"></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="analysis"></a>Analysis<a class="hash-link" href="#analysis" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="number-of-applications"></a>Number of Applications<a class="hash-link" href="#number-of-applications" title="Direct link to heading">#</a></h3><p>The experiment displayed above demonstrates a classical scenario for KubeVela. Although 3,000 applications are successfully managed by the KubeVela controller in this case, it is strongly recommended to adopt a smaller number (such as 2,000) of applications with the above configuration for the following reasons:
The time and resource consumption is closely associated with the spec of applications. If a lot of users apply larger applications with more pods and more other resources, 3,000 applications might break the resource limit more easily.
The memory and CPU usage shown above is approching resource limits. If memory drains, the KubeVela controller will crash and restart. If high CPU usage maintains for a long time, it might cause a long waiting queue in KubeVela controller which further lead to longer response time for application changes.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="configurations"></a>Configurations<a class="hash-link" href="#configurations" title="Direct link to heading">#</a></h3><p>There are several parameters users could config to adapt into their own scenario.
Using more replica for KubeVela controller do not scale up the ability of KubeVela controller. The leader election mechanism ensures that only one replica will work while others will wait. The aim of multi-replica is to support fast recovery when the working one crash. However, if the crash is caused by OOM, the recovery usually will not be able to fix that.
The number of qps and burst in the program configuration should be increased accordingly while scaling up KubeVela controller. These two parameters limit the capability for controller to send requests to apiserver.
Generally, in order to scale up KubeVela controller, scale up the resource limits and all the program parameters mentioned above (except the reconcile interval). If you have more applications to manage, add more memory. If you have higher operation frequency, add more CPU and threads, then increase qps and burst accordingly.
Longer reconcile interval allows more applications to handle, at the cost of longer time to fix potential underlying resource problems. For example, if one deployment managed by one application disappears, the routine reconciling can discover this problem and fix it.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="scaling-up"></a>Scaling Up<a class="hash-link" href="#scaling-up" title="Direct link to heading">#</a></h3><p>In addition to the experiment described above, we conducted another two experiment to test how well KubeVela controller can scale to larger clusters and more applications.</p><p>In a 500-node cluster, we tried to create 5,000 applications with the same spec described above, at the speed of 4 per second and lasted for around 21min. 1 core and 2 Gi memory are granted to KubeVela controller with the use of 4 concurrent reconcile threads. The kube-api-qps and kube-api-burst are raised to 500/800 correspondingly. All 30,000 pods successfully turn into Running phase. The time costs for each reconcile is similar to the previous experiment and CPU/Memory cost is not very high compared to the given resources. The regular reconciles for 5,000 applications takes 7~8 minutes, and no significant resource cost is observed. During this scaling, we found that the throughput of kube-apiserver starts to block the creation of application, as too many resources need to be created while applying applications.</p><p><img alt="std-cpu" src="/assets/images/std-cpu-ffd81b9aa9f3f19744fe28d7f9817e73.png">
<img alt="std-memory" src="/assets/images/std-memory-d0fb9771e7ab4d9588ef193424a76073.png"></p><p>Scaling up to 12,000 applications on 1,000 nodes is much harder than previous attempts. With the same creation speed, the apiserver will be flooded by lots of pod scheduling requests and finally start to drop application creation request. To overcome this difficulty, we divide the creation process of applications into several stage. Each stage only create 1,000~3,000 applications and the next stage will not begin until all pods are ready. With this strategy, we successfully create 12,000 applications, 24,000 deployments, 12,000 services, 12,000 ingress, 12,000 configmaps and 72,000 pods. The whole process takes about 30 hours. To hold this number of applications, KubeVela controller consumes 1.7 cores and 2.45 Gi memory. It takes about 12min to finish a full turn of regular reconciles for all 12,000 applications.</p><p><img alt="large-cpu" src="/assets/images/large-cpu-d83276edbb15f8a396f27ea144625469.png">
<img alt="large-memory" src="/assets/images/large-memory-360f435a8446f13a86246c19fad2f729.png">
<img alt="large-all" src="/assets/images/large-all-8b83d8c79d4faf56ba67aa9594ce5eee.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="future"></a>Future<a class="hash-link" href="#future" title="Direct link to heading">#</a></h3><p>The performance test of KubeVela demonstrates its ability of managing thousands of applications with limited resource consumption. It can also scale up to over 10,000 applications on large clusters with 1,000 nodes. In addition, KubeVela team also conducted similar pressure test for non-deployment based applications such as CloneSet in OpenKruise (which is not enclosed in this report) and reach same conclusions. In the future, we will add more performance tests for more complex scenario like Workflow or MultiCluster.</p></div><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog/tags/kubevela">kubevela</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_GeHD"><a href="/blog/kubevela-the-extensible-app-platform-based-on-open-application-model-and-kubernetes">KubeVela - The Extensible App Platform Based on Open Application Model and Kubernetes</a></h2><div class="margin-vert--md"><time datetime="2021-09-02T14:21:43.641Z" class="blogPostDate_fNvV">September 2, 2021 · 8 min read</time></div><div class="avatar margin-vert--md"><a href="https://github.com/JoelMarcey" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img src="https://avatars.githubusercontent.com/u/1701782?s=200&amp;v=4" alt="Lei Zhang and Fei Guo"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/JoelMarcey" target="_blank" rel="noopener noreferrer">Lei Zhang and Fei Guo</a></h4><small class="avatar__subtitle">CNCF TOC Member/Kubernetes</small></div></div></header><div class="markdown"><blockquote><p>7 Dec 2020 12:33pm, by Lei Zhang and Fei Guo</p></blockquote><p><img src="https://tva1.sinaimg.cn/large/ad5fbf65gy1glgj5q8inej208g049aa6.jpg" alt="image"></p><p>Last month at KubeCon+CloudNativeCon 2020, the <a href="https://github.com/oam-dev/spec" target="_blank" rel="noopener noreferrer">Open Application Model (OAM)</a> community launched <a href="https://github.com/oam-dev/kubevela/" target="_blank" rel="noopener noreferrer">KubeVela</a>, an easy-to-use yet highly extensible application platform based on OAM and Kubernetes.</p><p>For developers, KubeVela is an easy-to-use tool that enables you to describe and ship applications to Kubernetes with minimal effort, yet for platform builders, KubeVela serves as a framework that empowers them to create developer-facing yet fully extensible platforms at ease.</p><p>The trend of cloud native technology is moving towards pursuing consistent application delivery across clouds and on-premises infrastructures using Kubernetes as the common abstraction layer. Kubernetes, although excellent in abstracting low-level infrastructure details, does introduce extra complexity to application developers, namely understanding the concepts of pods, port exposing, privilege escalation, resource claims, CRD, and so on. We’ve seen the nontrivial learning curve and the lack of developer-facing abstraction have impacted user experiences, slowed down productivity, led to unexpected errors or misconfigurations in production.</p><p>Abstracting Kubernetes to serve developers’ requirements is a highly opinionated process, and the resultant abstractions would only make sense had the decision-makers been the platform builders. Unfortunately, the platform builders today face the following dilemma: There is no tool or framework for them to easily extend the abstractions if any.</p><p>Thus, many platforms today introduce restricted abstractions and add-on mechanisms despite the extensibility of Kubernetes. This makes easily extending such platforms for developers’ requirements or to wider scenarios almost impossible.</p><p>In the end, developers complain those platforms are too rigid and slow in response to feature requests or improvements. The platform builders do want to help but the engineering effort is daunting: any simple API change in the platform could easily become a marathon negotiation around the opinionated abstraction design.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="introducing-kubevela"></a>Introducing KubeVela<a class="hash-link" href="#introducing-kubevela" title="Direct link to heading">#</a></h2><p>With KubeVela, we aim to solve these two challenges in an approach that separates concerns of developers and platform builders.</p><p>For developers, KubeVela is an easy-to-use yet extensible tool that enables you to describe and deploy microservices applications with minimal effort. And instead of managing a handful of Kubernetes YAML files, a simple docker-compose style <code>appfile</code> is all you need.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="a-sample-appfile"></a>A Sample Appfile<a class="hash-link" href="#a-sample-appfile" title="Direct link to heading">#</a></h3><p>In this example, we will create a vela.yaml along with your app. This file describes how to build the image, how to deploy the image to Kubernetes, how to access the application and how the system would scale it automatically.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><div tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> testapp</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">services</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">express-server</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> oamdev/testapp</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">v1</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">build</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">docker</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">file</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Dockerfile</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">contrxt</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> .</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">cmd</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;node&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;server.js&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">8080</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">cpu</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;0.01&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">route</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">domain</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> example.com</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">rules</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">path</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> /testapp</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">rewriteTarget</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> /</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">autoscale</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">min</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">max</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">4</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">cpuPercent</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">5</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Just do: <code>$ vela up</code>, your app will then be alive on  <a href="https://example.com/testapp" target="_blank" rel="noopener noreferrer">https://example.com/testapp</a>.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="behind-the-appfile"></a>Behind the Appfile<a class="hash-link" href="#behind-the-appfile" title="Direct link to heading">#</a></h3><p>The <code>appfile</code> in KubeVela does not have a fixed schema specification, instead, what you can define in this file is determined by what kind of workload types and traits are available in your platform. These two concepts are core concepts from OAM, in detail:</p><ul><li><a href="https://kubevela.io/%23/en/concepts?id=workload-type-amp-trait" target="_blank" rel="noopener noreferrer">Workload type</a>, which declares the characteristics that runtime infrastructure should take into account in application deployment. In the sample above, it defines a “Web Service” workload named <code>express-server</code> as part of your application.</li><li><a href="https://kubevela.io/%23/en/concepts?id=workload-type-amp-trait" target="_blank" rel="noopener noreferrer">Trait</a>, which represents the operation configurations that are attached to an instance of workload type. Traits augment a workload type instance with operational features. In the sample above, it defines a route trait to access the application and an autoscale trait for the CPU based horizontal automatic scaling policy.</li></ul><p>Whenever a new workload type or trait is added, it would become immediately available to be declared in the <code>appfile</code>. Let’s say, a new trait named metrics is added, developers could check the schema of this trait by simply <code>$ vela show metrics</code> and define it in the previous sample <code>appfile</code>:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><div tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> testapp</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">services</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">express-server</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> webservice</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> oamdev/testapp</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">v1</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">build</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">docker</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">file</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Dockerfile</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">contrxt</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> .</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">cmd</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;node&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;server.js&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">8080</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">cpu</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;0.01&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">route</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">domain</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> example.com</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">rules</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">path</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> /testapp</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">rewriteTarget</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> /</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">autoscale</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">min</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">max</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">4</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">cpuPercent</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">5</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">metrices</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">8080</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">path</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;/metrics&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">scheme</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;http&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">enabled</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token boolean important">true</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="vela-up"></a>Vela Up<a class="hash-link" href="#vela-up" title="Direct link to heading">#</a></h2><p>The <code>vela up</code> command deploys the application defined in <code>appfile</code> to Kubernetes. After deployment, you can use <code>vela status</code> to check how to access your application following the <code>route</code> trait declared in <code>appfile</code>.</p><p><img src="https://tvax2.sinaimg.cn/large/ad5fbf65gy1glf9pyhr42j20la0kiafn.jpg"></p><p>Apps deployed with KubeVela will receive a URL (and versioned pre-release URLs) with valid TLS certificate automatically generated via <a href="https://cert-manager.io/docs/" target="_blank" rel="noopener noreferrer">cert-manager</a>. KubeVela also provides a set of commands (i.e. <code>vela logs, vela exec</code>) to best support your application management without becoming a Kubernetes expert. <a href="https://kubevela.io/%23/en/developers/learn-appfile" target="_blank" rel="noopener noreferrer">Learn more about vela up and appfile</a>.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="kubevela-for-platform-builders"></a>KubeVela for Platform Builders<a class="hash-link" href="#kubevela-for-platform-builders" title="Direct link to heading">#</a></h2><p>The above experience cannot be achieved without KubeVela’s innovative offerings to the platform builders as an extensible platform engine. These features are the hidden gems that make KubeVela unique. In details, KubeVela relieves the pains of building developer facing platforms on Kubernetes by doing the following:</p><ul><li><strong>Application Centric</strong>. Behind the appfile, KubeVela enforces “application” as its main API and all KubeVela’s capabilities serve the applications’ requirements only. This is how KubeVela brings application-centric context to the platform by default and changes building such platforms into working around application architecture.</li><li><strong>Extending Natively</strong>. As mentioned in the developer section, an application described by appfile is composed of various pluggable workload types and operation features (i.e. traits). Capabilities from Kubernetes ecosystem can be added to KubeVela as new workload types or traits through Kubernetes CRD registry mechanism at any time.</li><li><strong>Simple yet Extensible User Interface</strong>. Behind the <code>appfile</code>, KubeVela uses <a href="https://github.com/cuelang/cue" target="_blank" rel="noopener noreferrer">CUELang</a> as the “last mile” abstraction engine between user-facing schema and the control plane objects. KubeVela provides a set of built-in abstractions to start with and the platform builders are free to modify them at any time. Capability adding/updating or abstraction changes will all take effect at runtime, neither recompilation nor redeployment of KubeVela is required.</li></ul><p>Under the hood, KubeVela core is built on top of Crossplane OAM Kubernetes Runtime with KEDA, Flagger, Prometheus, etc as dependencies, yet its feature pool is “unlimited” and can be extended at any time.</p><p><img src="https://tva2.sinaimg.cn/large/ad5fbf65gy1glf9sktkdxj20q00dsacl.jpg"></p><p>With KubeVela, platform builders now have the tooling support to design and ship any new capabilities with abstractions to end-users with high confidence and low turnaround time. And for a developer, you only need to learn these abstractions, describe the app with them in a single file, and then ship it.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="not-another-paas-system"></a>Not Another PaaS System<a class="hash-link" href="#not-another-paas-system" title="Direct link to heading">#</a></h2><p>Most typical Platform-as-a-Service (PaaS) systems also provide full application management capabilities and aim to improve developer experience and efficiency. In this context, KubeVela shares the same goal.</p><p>Though unlike most typical PaaS systems which are either inextensible or create their own addon systems maintained by their own communities. KubeVela is designed to fully leverage the Kubernetes ecosystems as its capability pool. Hence, there’s no additional addon system introduced in this project. For platform builders, a new capability can be installed in KubeVela at any time by simply registering its API resource to OAM and providing a CUE template. We hope and expect that with the help of the open source community, the number of the KubeVela’s capabilities will grow dramatically over time. <a href="https://kubevela.io/%23/en/developers/cap-center" target="_blank" rel="noopener noreferrer">Learn more about using community capabilities by $vela cap</a>.</p><p>So in a nutshell, KubeVela is a Kubernetes plugin for building application-centric abstractions. It leverages the native Kubernetes extensibility and capabilities to resolve a hard problem – making application management enjoyable on Kubernetes.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="learn-more"></a>Learn More<a class="hash-link" href="#learn-more" title="Direct link to heading">#</a></h2><p>KubeVela is incubated by the OAM community as the successor of <a href="https://github.com/oam-dev/rudr" target="_blank" rel="noopener noreferrer">Rudr</a> project, while rather than being a reference implementation, KubeVela intends to be an end-to-end implementation that could be used in wider scenarios. The design of KubeVela’s appfile is also part of the experimental attempt in OAM specification to bring a simplified user experience to developers.</p><p>To learn more about KubeVela, please visit KubeVela’s <a href="https://kubevela.io/" target="_blank" rel="noopener noreferrer">documentation site</a>. The following content are also good next steps:</p><ul><li>Try out KubeVela following the <a href="https://kubevela.io/%23/en/quick-start" target="_blank" rel="noopener noreferrer">step-by-step tutorial</a> in its Quick Start page.</li><li>Give us feedback! KubeVela is still in its early stage and we are happy to ask the community for feedback via OAM <a href="https://gitter.im/oam-dev/community" target="_blank" rel="noopener noreferrer">Gitter</a> or <a href="https://cloud-native.slack.com/archives/C01BLQ3HTJA" target="_blank" rel="noopener noreferrer">Slack channel</a>.</li><li><a href="https://kubevela.io/%23/en/platform-engineers/trait" target="_blank" rel="noopener noreferrer">Extend KubeVela</a> to build your own platforms. If you have an idea for a new workload type, trait or try to build something more complex like a database or AI PaaS with KubeVela, post your idea as a GitHub Issue or propose it to the OAM community, we are eager to know.</li><li><a href="https://github.com/oam-dev/kubevela/blob/master/CONTRIBUTING.md" target="_blank" rel="noopener noreferrer">Contribute to KubeVela</a>. KubeVela is initialized by the open source community with <a href="https://github.com/oam-dev/kubevela/blob/bbb2c527d96d3e1a0694e2f49b3d1d1168e72c53/OWNERS_ALIASES%23L35" target="_blank" rel="noopener noreferrer">bootstrap contributors</a> from 8+ different organizations. We intend to donate this project to a neutral foundation as soon as it gets stable.</li></ul></div><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog/tags/kubevela">kubevela</a></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></main></div></div></div><footer class="footer"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Documentation</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/install">Getting Started</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/platform-engineers/overview">Platform Admin Guide</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/end-user/application">End User Guide</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://slack.cncf.io/" target="_blank" rel="noopener noreferrer" class="footer__link-item">CNCF Slack ( #kubevela channel )</a></li><li class="footer__item"><a href="https://gitter.im/oam-dev/community" target="_blank" rel="noopener noreferrer" class="footer__link-item">Gitter</a></li><li class="footer__item"><a class="footer__link-item" href="/">DingTalk (23310022)</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a href="https://github.com/oam-dev/kubevela" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">
        <br>
        <strong>© KubeVela Authors 2021 | Documentation Distributed under <a href="https://creativecommons.org/licenses/by/4.0">CC-BY-4.0</a> </strong> <strong>| Powered by <a href="https://www.netlify.com">Netlify</a></strong>
        <br>
        <br>
        © 2021 The Linux Foundation. All rights reserved. The Linux Foundation has registered trademarks and uses trademarks. For a list of trademarks of The Linux Foundation, please see our <a href="https://www.linuxfoundation.org/trademark-usage/"> Trademark Usage</a> page.
      </div></div></div></footer></div>
<script src="/assets/js/runtime~main.b842a96d.js"></script>
<script src="/assets/js/main.56dd577b.js"></script>
</body>
</html>